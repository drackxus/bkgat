<?php
?>
<style>
.the_champ_horizontal_sharing .theChampFacebookSvg, #the_champ_ss_rearrange .theChampFacebookSvg {
    background: url(data:image/svg+xml;charset=utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%25%22%20height%3D%22100%25%22%20viewBox%3D%22-5%20-5%2042%2042%22%3E%3Cpath%20d%3D%22M17.78%2027.5V17.008h3.522l.527-4.09h-4.05v-2.61c0-1.182.33-1.99%202.023-1.99h2.166V4.66c-.375-.05-1.66-.16-3.155-.16-3.123%200-5.26%201.905-5.26%205.405v3.016h-3.53v4.09h3.53V27.5h4.223z%22%20fill%3D%22%23FFFFFF%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E) no-repeat center center !important;
}
.the_champ_horizontal_sharing .theChampTwitterSvg, #the_champ_ss_rearrange .theChampTwitterSvg {
    background: url(data:image/svg+xml;charset=utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%25%22%20height%3D%22100%25%22%20viewBox%3D%22-4%20-4%2039%2039%22%3E%0A%3Cpath%20d%3D%22M28%208.557a9.913%209.913%200%200%201-2.828.775%204.93%204.93%200%200%200%202.166-2.725%209.738%209.738%200%200%201-3.13%201.194%204.92%204.92%200%200%200-3.593-1.55%204.924%204.924%200%200%200-4.794%206.049c-4.09-.21-7.72-2.17-10.15-5.15a4.942%204.942%200%200%200-.665%202.477c0%201.71.87%203.214%202.19%204.1a4.968%204.968%200%200%201-2.23-.616v.06c0%202.39%201.7%204.38%203.952%204.83-.414.115-.85.174-1.297.174-.318%200-.626-.03-.928-.086a4.935%204.935%200%200%200%204.6%203.42%209.893%209.893%200%200%201-6.114%202.107c-.398%200-.79-.023-1.175-.068a13.953%2013.953%200%200%200%207.55%202.213c9.056%200%2014.01-7.507%2014.01-14.013%200-.213-.005-.426-.015-.637.96-.695%201.795-1.56%202.455-2.55z%22%20fill%3D%22%23FFFFFF%22%3E%3C%2Fpath%3E%0A%3C%2Fsvg%3E) no-repeat center center !important;
}
.the_champ_horizontal_sharing .theChampWhatsappSvg, #the_champ_ss_rearrange .theChampWhatsappSvg {
    background: url(data:image/svg+xml;charset=utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%25%22%20height%3D%22100%25%22%20viewBox%3D%22-5%20-5%2040%2040%22%3E%3Cpath%20id%3D%22arc1%22%20stroke%3D%22%23FFFFFF%22%20stroke-width%3D%222%22%20fill%3D%22none%22%20d%3D%22M%2011.579798566743314%2024.396926207859085%20A%2010%2010%200%201%200%206.808479557110079%2020.73576436351046%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M%207%2019%20l%20-1%206%20l%206%20-1%22%20stroke%3D%22%23FFFFFF%22%20stroke-width%3D%222%22%20fill%3D%22none%22%3E%3C%2Fpath%3E%3Cpath%20d%3D%22M%2010%2010%20q%20-1%208%208%2011%20c%205%20-1%200%20-6%20-1%20-3%20q%20-4%20-3%20-5%20-5%20c%204%20-2%20-1%20-5%20-1%20-4%22%20fill%3D%22%23FFFFFF%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E) no-repeat center center !important;
}
.the_champ_horizontal_sharing .theChampEmailSvg, #the_champ_ss_rearrange .theChampEmailSvg {
    background: url(data:image/svg+xml;charset=utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22100%25%22%20height%3D%22100%25%22%20viewBox%3D%22-4%20-4%2043%2043%22%3E%3Cpath%20d%3D%22M%205.5%2011%20h%2023%20v%201%20l%20-11%206%20l%20-11%20-6%20v%20-1%20m%200%202%20l%2011%206%20l%2011%20-6%20v%2011%20h%20-22%20v%20-11%22%20stroke-width%3D%221%22%20fill%3D%22%23FFFFFF%22%3E%3C%2Fpath%3E%3C%2Fsvg%3E) no-repeat center center !important;
}
.felicitaciones {
    font-family: 'Gatorade black', sans-serif;
    font-size: 40px;
    text-align: center;
    margin-top: 24px;
    margin-bottom: 8px;
}
.the_champ_horizontal_sharing .theChampSharing {
    background-color: var(--color-orange);
    background: var(--color-orange);
}
.the_champ_horizontal_sharing .theChampSharing {
    color: var(--color-orange);
}
.msgAlertCont {
    border-radius: 30px;
}
a.contact_submit.w-button.aMsg {
    bottom: -31px;
    width: 84%;
}
p.txtMsg {
    font-size: 17px;
    line-height: 19px;
    width: 100%;
}
.list_retos_logrados_el {
    width: 100%;
    border-radius: 10px;
    margin-right: 1%;
    position: relative;
}
.list_retos_logrados_el {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    padding: 10px 20px;
    border-radius: 10px;
    width: 100%;
    height: 78px;
    background-repeat: no-repeat !important;
    background-size: cover !important;
    background-position: center center !important;
    margin-bottom: 0px;
    border-radius: 15px;
    background: black;
}
.list_retos_logrados_el h3 {
    color: white;
    font-family: 'Gatorade black', sans-serif;
    font-size: 13px !important;
    line-height: 14px !important;
    text-align: left;
    margin: 0px;
    width: 50%;
    z-index: 3;
    text-transform: uppercase;
}
.list_retos_logrados_el video {
    position: absolute;
    right: 0;
    bottom: 0;
    top: 0;
    right: 0;
    width: 100%;
    height: auto;
    background-size: 100% 100%;
    background-color: black;
    background-position: center center;
    background-size: contain;
    object-fit: cover;
    z-index: 1;
    opacity: 0.8;
    border-radius: 13px;
}
</style>
<?php
if (wp_is_mobile()) {
?>
    <style>
        h4 {
            font-family: 'Gatorade black';
            font-size: 32px;
            margin-top: 0px;
            margin-bottom: 14px;
        }

        .content_cont_h1_line {
            margin: 0 auto;
            margin-bottom: -7px;
        }

        .list_retos_logrados_el h3 {
            font-size: 14px !important;
            line-height: 15px !important;
            width: 62%;
        }

        p.txtMsg {
            font-size: 19px;
            line-height: 21px;
        }
    </style>
<?php
}
?>
<?php
global $post;
global $current_user;
//Si el usuario esta logueado
if (is_user_logged_in()) {

    //Obtenemos el id, el nombre del usuario y el correo
    $idUser = $current_user->ID;
    $emailUser = $current_user->user_email;
    $nameUser = get_user_meta($idUser, 'user_nombre', true);
    //Validamos la existencia de los meta user
    $retosCampana = get_user_meta($idUser, 'retos_campana', true);
    $retosContenido = get_user_meta($idUser, 'retos_contenido', true);


    if (gettype($retosCampana) == 'array') {
    } else {
        update_user_meta($idUser, 'retos_campana', []);
    }

    if (gettype($retosContenido) == 'array') {
    } else {
        update_user_meta($idUser, 'retos_contenido', []);
    }

    //Consultamos los retos activos y que esten dentro de la fecha
    $meta_query[] = array(
        'key' => 'estado',
        'value' => 'activo',
        'compare' => '=',
        'type' => 'char'
    );

    //Obtenemos los retos
    $args = array(
        'post_type' => 'retos',
        'posts_per_page' => -1,
        'post_status' => 'publish',
        'meta_query' => $meta_query
    );

    $lista_retos = get_posts($args);

    //Si hay retos
    if (count($lista_retos) > 0) {
        //Recorremos los retos
        foreach (get_posts($args) as $p) :
            $tipo_reto = get_post_meta($p->ID, 'tipo_retos', true);

            if ($tipo_reto == 'campana') {
                //Limpiar datos
                //   $retos_campana = [];
                //   update_user_meta($idUser, 'retos_campana', $retos_campana);


                $dtz = new DateTimeZone("America/Bogota");
                $dt = new DateTime("now", $dtz);
                $actual = $dt->format("Y-m-d");
                $inicio = get_post_meta($p->ID, 'fecha_inicio', true);
                $fin = get_post_meta($p->ID, 'fecha_fin', true);
                $actual = date('Y-m-d');

                $iniciof = strtotime($inicio);
                $finf = strtotime($fin);
                $actualf = strtotime($actual);

                // Comparando las fechas
                if (($actualf >= $iniciof) && ($actualf <= $finf)) {
                    //Obtenemos los retos de contenido del usuario
                    $retos_campana = get_user_meta($idUser, 'retos_campana', true);
                    //  var_dump($retos_campana);
                    //Obtenemos la tags del reto
                    $etiquetas_sel = get_post_meta($p->ID, 'etiquetas_sel', true);
                    //Obtenemos las tags del post
                    $etiquetasTarjetas = wp_get_post_terms($post->ID, 'etiquetasTarjetas');
                    //De string a array
                    $etiquetas_select = explode(",", $etiquetas_sel);
                    //Recorremos las tags del reto
                    foreach ($etiquetas_select as $etiq) {
                        //Obtenemos los meta del reto
                        $tipo_reto = get_post_meta($p->ID, 'tipo_retos', true);
                        $etiquetas_sel = get_post_meta($p->ID, 'etiquetas_sel', true);
                        $numero_visualizar = get_post_meta($p->ID, 'numero_visualizar', true);
                        $mensaje = get_post_meta($p->ID, 'mensaje_premio', true);
                        $video = get_post_meta($p->ID, 'video_premio', true);
                        $puntos = get_post_meta($p->ID, 'puntos', true);
                        $imagen_correo = get_post_meta($p->ID, 'imagen_correo', true);
                        $numero_correo = get_post_meta($p->ID, 'numero_correo', true);
                        $mensaje_correo = get_post_meta($p->ID, 'mensaje_correo', true);
                        //Validamos si el post tiene las tags del reto
                        if (array_search($etiq, array_column($etiquetasTarjetas, 'name')) !== false) {
                            $id = $p->ID;
                            //Si hay retos en curso
                            if (count($retos_campana) > 0) {
                                //Recorremos los retos en curso
                                for ($x = 0; $x < count($retos_campana); $x++) {
                                    //Si el reto es de tipo contenido
                                    if ($retos_campana[$x]['tipo'] == 'campana') {
                                        //Si el id del reto esta dentro del array de retos en curso
                                        if ($p->ID == $retos_campana[$x]['idReto']) {
                                            //   echo 'esta dentro del array';
                                            //   var_dump(get_user_meta($idUser, 'retos_campana', true));

                                            //Validando el estado del primer rango
                                            if ($retos_campana[$x]['estado'] != 'completado') {
                                                //Si no es vacio el rango
                                                if ($numero_correo != '') {
                                                    //Si el numero de elementos a visualizar y el numero de elementos visualizados es igual
                                                    if ($numero_correo == count($retos_campana[$x]['post'])) {
                                                        //Si al usuario no se le ha enviado el correo
                                                        if ($retos_campana[$x]['email'] == "false") {
                                                            //Si se establecio la imagen de correo
                                                            if ($imagen_correo != '') {
                                                                //Datos para enviar el correo
                                                                $to = $emailUser;
                                                                $subject = 'Gatorade - Avance de reto';
                                                                $body = '<style>@font-face {font-family: "Gatorade black";src: url(' . FONTSURL . 'Gatorade-Black.eot);} @font-face {font-family: "Gatorade medium";src: url(' . FONTSURL . 'Gatorade-Black.eot);}</style>';
                                                                $body .= '<table align="center" border="0" cellpadding="0" cellspacing="0" width="600" style="border-collapse: collapse;">';
                                                                $body .= '<tr>';
                                                                $body .= '<td style="padding:26px;" colspan="3">';
                                                                $body .= '<a href="' . home_url() . '">';
                                                                $body .= '<img src="' . IMGURL . 'desktop/header/logo_black.png" style="width:66px;margin:0 auto;display:block;"/>';
                                                                $body .= '</a>';
                                                                $body .= '</td>';
                                                                $body .= '</tr>';
                                                                $body .= '<tr>';
                                                                $body .= '<td colspan="3">';
                                                                $body .= '<img src="' . $imagen_correo . '" style="width:100%;margin:0 auto;display:block;"/>';
                                                                $body .= '</td>';
                                                                $body .= '</tr>';
                                                                $body .= '<tr>';
                                                                $body .= '<td style="text-align:center" colspan="3">';
                                                                $body .= '<h3 style="color:#FF8901;text-align:center;font-size:34px;font-family:Gatorade,Rockwell,Georgia,serif;text-transform:uppercase;">Hola ' . $nameUser . ',</h3>';
                                                                $body .= '</td>';
                                                                $body .= '</tr>';
                                                                $body .= '<tr>';
                                                                $body .= '<td colspan="3">';
                                                                $body .= '<div style="width:60px;background:#FF8901;height:1px;margin:0 auto;"></div>';
                                                                $body .= '</td>';
                                                                $body .= '</tr>';
                                                                $body .= '<tr>';
                                                                $body .= '<td style="text-align:center" colspan="3">';
                                                                $body .= '<p style="color:black;text-align:center;font-size:18px;padding:8px 40px 20px;font-family:Gatorade,Rockwell,Georgia,serif;">' . $mensaje_correo . '</p>';
                                                                $body .= '</td>';
                                                                $body .= '</tr>';
                                                                $body .= '<tr>';
                                                                $body .= '<td style="text-align:center" colspan="3">';
                                                                $body .= '<a style="background:black;color:white;text-align:center;font-size:17px;padding:12px 20px 10px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;" href="' . home_url() . '">DESCUBRE M√ÅS AQU√ç</a>';
                                                                $body .= '</td>';
                                                                $body .= '</tr>';
                                                                $body .= '<tr>';
                                                                $body .= '<td style="padding:26px;" colspan="3">';
                                                                $body .= '<br>';
                                                                $body .= '</td>';
                                                                $body .= '</tr>';
                                                                $body .= '<tr style="background:#000000;">';
                                                                $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                                $body .= '<a href="' . network_site_url() . 'wp-content/media/2021/06/TeÃÅrminos-de-Uso.pdf" style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">TERMINOS Y CONDICIONES</a>';
                                                                $body .= '</td>';
                                                                $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                                $body .= '<a href="' . network_site_url() . 'wp-content/media/2021/06/PoliÃÅtica-de-privacidad.pdf" style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">POL√çTICAS DE PRIVACIDAD</a>';
                                                                $body .= '</td>';
                                                                $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                                $body .= '<a style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">CANCELAR SUSCRIPCI√ìN</a>';
                                                                $body .= '</td>';
                                                                $body .= '</tr>';
                                                                $body .= '<tr style="background:#000000;">';
                                                                $body .= '<td style="padding:0px 16px 17px;" colspan="3">';
                                                                $body .= '<a href="' . home_url() . '">';
                                                                $body .= '<img src="' . IMGURL . 'desktop/Logo.png" style="width:33px;margin:0 auto;display:block;"/>';
                                                                $body .= '</a>';
                                                                $body .= '</td>';
                                                                $body .= '</tr>';
                                                                $body .= '</table>';
                                                                $headers = array('Content-Type: text/html; charset=UTF-8');
                                                                //Enviando el correo
                                                                wp_mail($to, $subject, $body, $headers);
                                                                $retos_campana[$x]['email'] = "true";
                                                                update_user_meta($idUser, 'retos_campana', $retos_campana);
                                                            }
                                                        }
                                                        //Si el usuario no ha visto el popup
                                                        if ($retos_campana[$x]['popup_visualizaciones'] == "false") {
?>
                                                            <script>
                                                                jQuery('.msgAlert').css('display', 'flex');
                                                                jQuery('.msgAlert .txtMsg').html(`<h4 class="felicitaciones" style="text-transform:uppercase;">RETO ACTIVADO:</h4><div class="content_cont_h1_line"></div><br><?php echo $mensaje_correo; ?><br><br><div class="list_retos_logrados_el"> <div><video style="filter: brightness(0.4)"> <source src="<?php echo $video; ?>" type="video/mp4"> </video></div><h3> <?php echo $p->post_title; ?> </h3></div></div>`);
                                                                jQuery('.msgAlert .aMsg').css('display', 'block');
                                                                jQuery('.msgAlert .txtMsg').css('margin-bottom', '-18px');
                                                                jQuery('.msgAlert .aMsg').html('Ir a la b√∫squeda de m√°s contenidos');
                                                                jQuery('.msgAlert .aMsg').css('font-size', '12px');
                                                                jQuery('.msgAlert .aMsg').attr('href', '<?php echo home_url(); ?>');
                                                            </script>
                                                        <?php
                                                            $retos_campana[$x]['popup_visualizaciones'] = "true";
                                                            // var_dump($retos_campana);
                                                            update_user_meta($idUser, 'retos_campana', $retos_campana);
                                                        }
                                                        //El numero de elementos a visualizar y el numero de elementos visualizados no es igual
                                                    } else {
                                                        //Si el id de la publicacion esta en el array de retos
                                                        if (in_array($post->ID, $retos_campana[$x]['post'])) {
                                                            $retos_campana[$x]['estado'] = 'pendiente';
                                                            update_user_meta($idUser, 'retos_campana', $retos_campana);
                                                        } else {
                                                            $retos_campana[$x]['estado'] = 'pendiente';
                                                            $retos_campana[$x]['post'][] = $post->ID;
                                                            update_user_meta($idUser, 'retos_campana', $retos_campana);
                                                        }
                                                    }
                                                }

                                                //Si no es vacio el rango
                                                if ($numero_visualizar != '') {
                                                    //Si el numero de elementos a visualizar y el numero de elementos visualizados es igual
                                                    if (count($retos_campana[$x]['post']) >= $numero_visualizar) {
                                                        //Si el usuario no ha visto el popup
                                                        if ($retos_campana[$x]['popup'] == "false") {
                                                        ?>
                                                            <script>
                                                                jQuery('.msgAlert').css('display', 'flex');
                                                                jQuery('.msgAlert .txtMsg').html(`<h4 class="felicitaciones" style="text-transform:uppercase;">RETO ACTIVADO:</h4><div class="content_cont_h1_line"></div><br><div class="list_retos_logrados_el"> <div><video autoplay muted loop playsinline> <source src="<?php echo $video; ?>" type="video/mp4"> </video></div><h3> <?php echo $p->post_title; ?> </h3></div><p style="color: black;text-align: center;font-family: 'Gatorade black';font-size: 17px;width: 100%;margin: 0;padding: 20px 0px 8px;line-height: 19px;">¬°COMPARTE TU MEDALLA CON TUS AMIGOS E INVITALOS AL DESAFIO!</p><div class="the_champ_sharing_container the_champ_horizontal_sharing" style="padding-bottom:20px;" ss-offset="0" super-socializer-data-href="<?php echo home_url('retos'); ?>"> <div style="font-weight:bold" class="the_champ_sharing_title"></div><ul class="the_champ_sharing_ul" style="display:flex;justify-content:center;align-items:center;width:100%;"> <li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Facebook" title="Facebook" class="theChampSharing theChampFacebookBackground" onclick='theChampPopup("https://www.facebook.com/sharer/sharer.php?u=<?php echo home_url('retos'); ?>&quote=¬°Hoy supere otro Reto! √önete y Alcanza tu m√°ximo potencial. Acepta el reto <?php echo home_url(); ?>")'> <ss style="display:block;border-radius:999px;" class="theChampSharingSvg theChampFacebookSvg"> </ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Twitter" title="Twitter" class="theChampSharing theChampTwitterBackground" onclick='theChampPopup("http://twitter.com/intent/tweet?text=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ <?php echo home_url(); ?>&amp;url=<?php echo home_url('retos'); ?>")' > <ss style="display:block;border-radius:999px;" class="theChampSharingSvg theChampTwitterSvg"></ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Whatsapp" title="Whatsapp" class="theChampSharing theChampWhatsappBackground" onclick='theChampPopup("https://web.whatsapp.com/send?text=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ <?php echo home_url('retos'); ?>")' > <ss style="display:block" class="theChampSharingSvg theChampWhatsappSvg"></ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Email" title="Email" class="theChampSharing theChampEmailBackground" onclick="window.open('mailto:?subject=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ gatorade.lat&amp;body=' + decodeURIComponent('<?php echo home_url('retos'); ?>' ), '_blank')"> <ss style="display:block" class="theChampSharingSvg theChampEmailSvg"></ss> </i> </li></ul> <div style="clear:both"></div></div>`);
                                                                jQuery('.msgAlert .aMsg').css('display', 'block');
                                                                jQuery('.msgAlert .txtMsg').css('margin-bottom', '-32px');
                                                                jQuery('.msgAlert .aMsg').html('IR A TU PERFIL');
                                                                jQuery('.msgAlert .aMsg').attr('href', '<?php echo home_url('perfil'); ?>');
                                                            </script>
                <?php
                                                            $retos_campana[$x]['popup'] = "true";
                                                            $retos_campana[$x]['estado'] = "completado";
                                                            $gpoints = get_user_meta($idUser, 'gpoints', true);
                                                            if ($gpoints == '' || $gpoints == null) {
                                                                $gpoints = 0;
                                                            }
                                                            $winPoints = $gpoints + $puntos;
                                                            update_user_meta($idUser, 'retos_campana', $retos_campana);
                                                            update_user_meta($idUser, 'gpoints', $winPoints);
                                                        }
                                                        //El numero de elementos a visualizar y el numero de elementos visualizados no es igual
                                                    } else {
                                                        //Si el id de la publicacion esta en el array de retos
                                                        if (in_array($post->ID, $retos_campana[$x]['post'])) {
                                                            $retos_campana[$x]['estado'] = 'pendiente';
                                                            $retos_campana[$x]['popup'] = "false";
                                                            update_user_meta($idUser, 'retos_campana', $retos_campana);
                                                        } else {
                                                            $retos_campana[$x]['estado'] = 'pendiente';
                                                            $retos_campana[$x]['post'][] = $post->ID;
                                                            $retos_campana[$x]['popup'] = "false";
                                                            update_user_meta($idUser, 'retos_campana', $retos_campana);
                                                        }
                                                    }
                                                }
                                            }
                                        } else {
                                            //   echo 'no esta dentro del array';
                                            array_push($retos_campana, array(
                                                "idReto" => $id,
                                                "estado" => "pendiente",
                                                "tipo" => "campana",
                                                "popup" => "false",
                                                "popup_visualizaciones" => "false",
                                                "email" => "false",
                                                "post" => array(
                                                    $post->ID
                                                )
                                            ));
                                            update_user_meta($idUser, 'retos_campana', $retos_campana);
                                        }
                                    }
                                }
                            } else {
                                array_push($retos_campana, array(
                                    "idReto" => $id,
                                    "estado" => "pendiente",
                                    "tipo" => "campana",
                                    "popup" => "false",
                                    "popup_visualizaciones" => "false",
                                    "email" => "false",
                                    "post" => array(
                                        $post->ID
                                    )
                                ));
                                update_user_meta($idUser, 'retos_campana', $retos_campana);
                            }
                        }
                    }
                }
            }





            if ($tipo_reto == 'contenido') {
                //Obtenemos los retos de contenido del usuario
                $retos_contenido = get_user_meta($idUser, 'retos_contenido', true);
                ?>
                <?php

                //Obtenemos la categoria del reto
                $categoria_sel = get_post_meta($p->ID, 'categoria_sel', true);
                //Obtenemos las categorias del post
                $categoriasTarjetas = wp_get_post_terms($post->ID, 'categoriasTarjetas');
                //Recorremos las categorias
                foreach ($categoriasTarjetas as $term) {
                    //Si la categoria del post es igual a la categoria del reto
                    if ($term->name == $categoria_sel) {
                        $rango1 = get_post_meta($p->ID, 'rango1', true);
                        $rango1_puntos = get_post_meta($p->ID, 'rango1_puntos', true);
                        $rango1_titulo = get_post_meta($p->ID, 'rango1_titulo', true);
                        $rango1_mensaje_premio = get_post_meta($p->ID, 'rango1_mensaje_premio', true);
                        $rango1_video_premio = get_post_meta($p->ID, 'rango1_video_premio', true);
                        $rango1_imagen_correo = get_post_meta($p->ID, 'rango1_imagen_correo', true);

                        $rango2 = get_post_meta($p->ID, 'rango2', true);
                        $rango2_puntos = get_post_meta($p->ID, 'rango2_puntos', true);
                        $rango2_titulo = get_post_meta($p->ID, 'rango2_titulo', true);
                        $rango2_mensaje_premio = get_post_meta($p->ID, 'rango2_mensaje_premio', true);
                        $rango2_video_premio = get_post_meta($p->ID, 'rango2_video_premio', true);
                        $rango2_imagen_correo = get_post_meta($p->ID, 'rango2_imagen_correo', true);

                        $rango3 = get_post_meta($p->ID, 'rango3', true);
                        $rango3_puntos = get_post_meta($p->ID, 'rango3_puntos', true);
                        $rango3_titulo = get_post_meta($p->ID, 'rango3_titulo', true);
                        $rango3_mensaje_premio = get_post_meta($p->ID, 'rango3_mensaje_premio', true);
                        $rango3_video_premio = get_post_meta($p->ID, 'rango3_video_premio', true);
                        $rango3_imagen_correo = get_post_meta($p->ID, 'rango3_imagen_correo', true);

                        $id = $p->ID;
                        //Si hay retos en curso
                        if (count($retos_contenido) > 0) {
                            //Recorremos los retos en curso
                            for ($x = 0; $x < count($retos_contenido); $x++) {
                                //Si el reto es de tipo contenido
                                if ($retos_contenido[$x]['tipo'] == 'contenido') {
                                    //Si el id del reto esta dentro del array de retos en curso
                                    if ($p->ID == $retos_contenido[$x]['idReto']) {
                                        //Validando el estado del primer rango
                                        if ($retos_contenido[$x]['rangos'][0]['estado1'] != 'completado') {
                                            //Si no es vacio el rango1
                                            if ($rango1 != '') {
                                                //Si el numero de elementos a visualizar y el numero de elementos visualizados es igual
                                                if ($rango1 == count($retos_contenido[$x]['post'])) {
                                                    $retos_contenido[$x]['rangos'][0]['estado1'] = 'completado';
                                                    $new_points = get_user_meta($idUser, 'gpoints', true);
                                                    $new_points = $new_points + $rango1_puntos;
                                                    update_user_meta($idUser, 'gpoints', $new_points);
                                                    //Si al usuario no se le ha enviado el correo
                                                    if ($retos_contenido[$x]['rangos'][0]['email1'] == "false") {
                                                        //Si se establecio la imagen de correo
                                                        if ($rango1_imagen_correo != '') {
                                                            //Datos para enviar el correo
                                                            $to = $emailUser;
                                                            $subject = 'Gatorade - Reto cumplido';
                                                            $body = '<style>@font-face {font-family: "Gatorade black";src: url(' . FONTSURL . 'Gatorade-Black.eot);} @font-face {font-family: "Gatorade medium";src: url(' . FONTSURL . 'Gatorade-Black.eot);}</style>';
                                                            $body .= '<table align="center" border="0" cellpadding="0" cellspacing="0" width="600" style="border-collapse: collapse;">';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="padding:26px;" colspan="3">';
                                                            $body .= '<a href="' . home_url() . '">';
                                                            $body .= '<img src="' . IMGURL . 'desktop/header/logo_black.png" style="width:66px;margin:0 auto;display:block;"/>';
                                                            $body .= '</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td colspan="3">';
                                                            $body .= '<img src="' . $rango1_imagen_correo . '" style="width:100%;margin:0 auto;display:block;"/>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="text-align:center" colspan="3">';
                                                            $body .= '<h3 style="color:#FF8901;text-align:center;font-size:34px;font-family:Gatorade,Rockwell,Georgia,serif;text-transform:uppercase;">Hola ' . $nameUser . ',</h3>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td colspan="3">';
                                                            $body .= '<div style="width:60px;background:#FF8901;height:1px;margin:0 auto;"></div>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="text-align:center" colspan="3">';
                                                            $body .= '<p style="color:black;text-align:center;font-size:18px;padding:8px 40px 20px;font-family:Gatorade,Rockwell,Georgia,serif;">' . $rango1_mensaje_premio . '</p>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="text-align:center" colspan="3">';
                                                            $body .= '<a style="background:black;color:white;text-align:center;font-size:17px;padding:12px 20px 10px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;" href="' . home_url() . '">DESCUBRE M√ÅS AQU√ç</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="padding:26px;" colspan="3">';
                                                            $body .= '<br>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr style="background:#000000;">';
                                                            $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                            $body .= '<a href="' . network_site_url() . 'wp-content/media/2021/06/TeÃÅrminos-de-Uso.pdf" style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">TERMINOS Y CONDICIONES</a>';
                                                            $body .= '</td>';
                                                            $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                            $body .= '<a href="' . network_site_url() . 'wp-content/media/2021/06/PoliÃÅtica-de-privacidad.pdf" style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">POL√çTICAS DE PRIVACIDAD</a>';
                                                            $body .= '</td>';
                                                            $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                            $body .= '<a style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">CANCELAR SUSCRIPCI√ìN</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr style="background:#000000;">';
                                                            $body .= '<td style="padding:0px 16px 17px;" colspan="3">';
                                                            $body .= '<a href="' . home_url() . '">';
                                                            $body .= '<img src="' . IMGURL . 'desktop/Logo.png" style="width:33px;margin:0 auto;display:block;"/>';
                                                            $body .= '</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '</table>';
                                                            $headers = array(
                                                                'Content-Type: text/html; charset=UTF-8'
                                                            );
                                                            //Enviando el correo
                                                            wp_mail($to, $subject, $body, $headers);
                                                            $retos_contenido[$x]['rangos'][0]['email1'] = "true";
                                                            update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                        }
                                                    }
                                                    //Si el usuario no ha visto el popup
                                                    if ($retos_contenido[$x]['rangos'][0]['popup1'] == "false") {
                ?>
                                                        <script>
                                                            jQuery('.msgAlert').css('display', 'flex');
                                                            jQuery('.msgAlert .txtMsg').html(`<h4 class="felicitaciones" style="text-transform:uppercase;">RETO ACTIVADO:</h4><div class="content_cont_h1_line"></div><br><div class="list_retos_logrados_el"> <div><video autoplay muted loop playsinline> <source src="<?php echo $rango1_video_premio; ?>" type="video/mp4"> </video></div><h3> <?php echo $rango1_titulo; ?> </h3></div><p style="color: black;text-align: center;font-family: 'Gatorade black';font-size: 17px;width: 100%;margin: 0;padding: 20px 0px 8px;line-height: 19px;">¬°COMPARTE TU MEDALLA CON TUS AMIGOS E INVITALOS AL DESAFIO!</p><div class="the_champ_sharing_container the_champ_horizontal_sharing" style="padding-bottom:20px;" ss-offset="0" super-socializer-data-href="<?php echo home_url('retos'); ?>"> <div style="font-weight:bold" class="the_champ_sharing_title"></div><ul class="the_champ_sharing_ul" style="display:flex;justify-content:center;align-items:center;width:100%;"> <li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Facebook" title="Facebook" class="theChampSharing theChampFacebookBackground" onclick='theChampPopup("https://www.facebook.com/sharer/sharer.php?u=<?php echo home_url('retos'); ?>&quote=¬°Hoy supere otro Reto! √önete y Alcanza tu m√°ximo potencial. Acepta el reto <?php echo home_url(); ?>")' > <ss style="display:block;border-radius:999px;" class="theChampSharingSvg theChampFacebookSvg"> </ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Twitter" title="Twitter" class="theChampSharing theChampTwitterBackground" onclick='theChampPopup("http://twitter.com/intent/tweet?text=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ <?php echo home_url(); ?>&amp;url=<?php echo home_url('retos'); ?>")'> <ss style="display:block;border-radius:999px;" class="theChampSharingSvg theChampTwitterSvg"></ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Whatsapp" title="Whatsapp" class="theChampSharing theChampWhatsappBackground" onclick='theChampPopup("https://web.whatsapp.com/send?text=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ <?php echo home_url('retos'); ?>")' > <ss style="display:block" class="theChampSharingSvg theChampWhatsappSvg"></ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Email" title="Email" class="theChampSharing theChampEmailBackground" onclick="window.open('mailto:?subject=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ gatorade.lat&amp;body=' + decodeURIComponent('<?php echo home_url('retos'); ?>' ), '_blank')"> <ss style="display:block" class="theChampSharingSvg theChampEmailSvg"></ss> </i> </li></ul> <div style="clear:both"></div></div>`);
                                                            jQuery('.msgAlert .aMsg').css('display', 'block');
                                                            jQuery('.msgAlert .txtMsg').css('margin-bottom', '-32px');
                                                            jQuery('.msgAlert .aMsg').html('IR A TU PERFIL');
                                                            jQuery('.msgAlert .aMsg').attr('href', '<?php echo home_url('perfil'); ?>');
                                                        </script>
                                                    <?php
                                                        $retos_contenido[$x]['rangos'][0]['popup1'] = "true";
                                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                    }
                                                    //El numero de elementos a visualizar y el numero de elementos visualizados no es igual
                                                } else {
                                                    //Si el id de la publicacion esta en el array de retos
                                                    if (in_array($post->ID, $retos_contenido[$x]['post'])) {
                                                        $retos_contenido[$x]['rangos'][0]['estado1'] = 'pendiente';
                                                        $retos_contenido[$x]['rangos'][0]['popup1'] = "false";
                                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                    } else {
                                                        $retos_contenido[$x]['rangos'][0]['estado1'] = 'pendiente';
                                                        $retos_contenido[$x]['post'][] = $post->ID;
                                                        $retos_contenido[$x]['rangos'][0]['popup1'] = "false";
                                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                    }
                                                }
                                            }
                                        }

                                        if ($retos_contenido[$x]['rangos'][0]['estado2'] != 'completado') {
                                            //Si el numero de elementos a visualizar y el numero de elementos visualizados es igual
                                            if ($rango2 != '') {
                                                if ($rango2 == count($retos_contenido[$x]['post'])) {
                                                    $retos_contenido[$x]['rangos'][0]['estado2'] = 'completado';
                                                    $new_points = get_user_meta($idUser, 'gpoints', true);
                                                    $new_points = $new_points + $rango2_puntos;
                                                    update_user_meta($idUser, 'gpoints', $new_points);
                                                    //Si al usuario no se le ha enviado el correo
                                                    if ($retos_contenido[$x]['rangos'][0]['email2'] == "false") {
                                                        if ($rango2_imagen_correo != '') {
                                                            //Datos para enviar el correo
                                                            $to = $emailUser;
                                                            $subject = 'Gatorade - Reto cumplido';
                                                            $body = '<style>@font-face {font-family: "Gatorade black";src: url(' . FONTSURL . 'Gatorade-Black.eot);} @font-face {font-family: "Gatorade medium";src: url(' . FONTSURL . 'Gatorade-Black.eot);}</style>';
                                                            $body .= '<table align="center" border="0" cellpadding="0" cellspacing="0" width="600" style="border-collapse: collapse;">';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="padding:26px;" colspan="3">';
                                                            $body .= '<a href="' . home_url() . '">';
                                                            $body .= '<img src="' . IMGURL . 'desktop/header/logo_black.png" style="width:66px;margin:0 auto;display:block;"/>';
                                                            $body .= '</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td colspan="3">';
                                                            $body .= '<img src="' . $rango2_imagen_correo . '" style="width:100%;margin:0 auto;display:block;"/>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="text-align:center" colspan="3">';
                                                            $body .= '<h3 style="color:#FF8901;text-align:center;font-size:34px;font-family:Gatorade,Rockwell,Georgia,serif;text-transform:uppercase;">Hola ' . $nameUser . ',</h3>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td colspan="3">';
                                                            $body .= '<div style="width:60px;background:#FF8901;height:1px;margin:0 auto;"></div>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="text-align:center" colspan="3">';
                                                            $body .= '<p style="color:black;text-align:center;font-size:18px;padding:8px 40px 20px;font-family:Gatorade,Rockwell,Georgia,serif;">' . $rango2_mensaje_premio . '</p>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="text-align:center" colspan="3">';
                                                            $body .= '<a style="background:black;color:white;text-align:center;font-size:17px;padding:12px 20px 10px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;" href="' . home_url() . '">DESCUBRE M√ÅS AQU√ç</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="padding:26px;" colspan="3">';
                                                            $body .= '<br>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr style="background:#000000;">';
                                                            $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                            $body .= '<a href="' . network_site_url() . 'wp-content/media/2021/06/TeÃÅrminos-de-Uso.pdf" style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">TERMINOS Y CONDICIONES</a>';
                                                            $body .= '</td>';
                                                            $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                            $body .= '<a href="' . network_site_url() . 'wp-content/media/2021/06/PoliÃÅtica-de-privacidad.pdf" style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">POL√çTICAS DE PRIVACIDAD</a>';
                                                            $body .= '</td>';
                                                            $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                            $body .= '<a style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;" href="#">CANCELAR SUSCRIPCI√ìN</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr style="background:#000000;">';
                                                            $body .= '<td style="padding:0px 16px 17px;" colspan="3">';
                                                            $body .= '<a href="' . home_url() . '">';
                                                            $body .= '<img src="' . IMGURL . 'desktop/Logo.png" style="width:33px;margin:0 auto;display:block;"/>';
                                                            $body .= '</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '</table>';
                                                            $headers = array(
                                                                'Content-Type: text/html; charset=UTF-8'
                                                            );
                                                            //Enviando el correo
                                                            wp_mail($to, $subject, $body, $headers);
                                                            $retos_contenido[$x]['rangos'][0]['email2'] = "true";
                                                            update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                        }
                                                    }
                                                    //Si el usuario no ha visto el popup
                                                    if ($retos_contenido[$x]['rangos'][0]['popup2'] == "false") {
                                                    ?>
                                                        <script>
                                                            jQuery('.msgAlert').css('display', 'flex');
                                                            jQuery('.msgAlert .txtMsg').html(`<h4 class="felicitaciones" style="text-transform:uppercase;">RETO ACTIVADO:</h4><div class="content_cont_h1_line"></div><br><div class="list_retos_logrados_el"> <div><video autoplay muted loop playsinline> <source src="<?php echo $rango2_video_premio; ?>" type="video/mp4"> </video></div><h3> <?php echo $rango2_titulo; ?> </h3></div><p style="color: black;text-align: center;font-family: 'Gatorade black';font-size: 17px;width: 100%;margin: 0;padding: 20px 0px 8px;line-height: 19px;">¬°COMPARTE TU MEDALLA CON TUS AMIGOS E INVITALOS AL DESAFIO!</p><div class="the_champ_sharing_container the_champ_horizontal_sharing" style="padding-bottom:20px;" ss-offset="0" super-socializer-data-href="<?php echo home_url('retos'); ?>"> <div style="font-weight:bold" class="the_champ_sharing_title"></div><ul class="the_champ_sharing_ul" style="display:flex;justify-content:center;align-items:center;width:100%;"> <li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Facebook" title="Facebook" class="theChampSharing theChampFacebookBackground" onclick='theChampPopup("https://www.facebook.com/sharer/sharer.php?u=<?php echo home_url('retos'); ?>&quote=¬°Hoy supere otro Reto! √önete y Alcanza tu m√°ximo potencial. Acepta el reto <?php echo home_url(); ?>")' > <ss style="display:block;border-radius:999px;" class="theChampSharingSvg theChampFacebookSvg"> </ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Twitter" title="Twitter" class="theChampSharing theChampTwitterBackground" onclick='theChampPopup("http://twitter.com/intent/tweet?text=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ <?php echo home_url(); ?>&amp;url=<?php echo home_url('retos'); ?>")'> <ss style="display:block;border-radius:999px;" class="theChampSharingSvg theChampTwitterSvg"></ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Whatsapp" title="Whatsapp" class="theChampSharing theChampWhatsappBackground" onclick='theChampPopup("https://web.whatsapp.com/send?text=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ <?php echo home_url('retos'); ?>")' > <ss style="display:block" class="theChampSharingSvg theChampWhatsappSvg"></ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Email" title="Email" class="theChampSharing theChampEmailBackground" onclick="window.open('mailto:?subject=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ gatorade.lat&amp;body=' + decodeURIComponent('<?php echo home_url('retos'); ?>' ), '_blank')"> <ss style="display:block" class="theChampSharingSvg theChampEmailSvg"></ss> </i> </li></ul> <div style="clear:both"></div></div>`);
                                                            jQuery('.msgAlert .aMsg').css('display', 'block');
                                                            jQuery('.msgAlert .txtMsg').css('margin-bottom', '-32px');
                                                            jQuery('.msgAlert .aMsg').html('IR A TU PERFIL');
                                                            jQuery('.msgAlert .aMsg').attr('href', '<?php echo home_url('perfil'); ?>');
                                                        </script>
                                                    <?php
                                                        $retos_contenido[$x]['rangos'][0]['popup2'] = "true";
                                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                    }
                                                    //El numero de elementos a visualizar y el numero de elementos visualizados no es igual

                                                } else {
                                                    if (in_array($post->ID, $retos_contenido[$x]['post'])) {
                                                        $retos_contenido[$x]['rangos'][0]['estado2'] = 'pendiente';
                                                        $retos_contenido[$x]['rangos'][0]['popup2'] = "false";
                                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                    } else {
                                                        $retos_contenido[$x]['rangos'][0]['estado2'] = 'pendiente';
                                                        $retos_contenido[$x]['post'][] = $post->ID;
                                                        $retos_contenido[$x]['rangos'][0]['popup2'] = "false";
                                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                    }
                                                }
                                            }
                                        }

                                        if ($retos_contenido[$x]['rangos'][0]['estado3'] != 'completado') {
                                            //Si el numero de elementos a visualizar y el numero de elementos visualizados es igual
                                            if ($rango3 != '') {
                                                if ($rango3 == count($retos_contenido[$x]['post'])) {
                                                    $retos_contenido[$x]['rangos'][0]['estado3'] = 'completado';
                                                    $new_points = get_user_meta($idUser, 'gpoints', true);
                                                    $new_points = $new_points + $rango3_puntos;
                                                    update_user_meta($idUser, 'gpoints', $new_points);
                                                    //Si al usuario no se le ha enviado el correo
                                                    if ($retos_contenido[$x]['rangos'][0]['email3'] == "false") {
                                                        if ($rango3_imagen_correo != '') {
                                                            //Datos para enviar el correo
                                                            $to = $emailUser;
                                                            $subject = 'Gatorade - Reto cumplido';
                                                            $body = '<style>@font-face {font-family: "Gatorade black";src: url(' . FONTSURL . 'Gatorade-Black.eot);} @font-face {font-family: "Gatorade medium";src: url(' . FONTSURL . 'Gatorade-Black.eot);}</style>';
                                                            $body .= '<table align="center" border="0" cellpadding="0" cellspacing="0" width="600" style="border-collapse: collapse;">';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="padding:26px;" colspan="3">';
                                                            $body .= '<a href="' . home_url() . '">';
                                                            $body .= '<img src="' . IMGURL . 'desktop/header/logo_black.png" style="width:66px;margin:0 auto;display:block;"/>';
                                                            $body .= '</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td colspan="3">';
                                                            $body .= '<img src="' . $rango3_imagen_correo . '" style="width:100%;margin:0 auto;display:block;"/>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="text-align:center" colspan="3">';
                                                            $body .= '<h3 style="color:#FF8901;text-align:center;font-size:34px;font-family:Gatorade,Rockwell,Georgia,serif;text-transform:uppercase;">Hola ' . $nameUser . ',</h3>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td colspan="3">';
                                                            $body .= '<div style="width:60px;background:#FF8901;height:1px;margin:0 auto;"></div>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="text-align:center" colspan="3">';
                                                            $body .= '<p style="color:black;text-align:center;font-size:18px;padding:8px 40px 20px;font-family:Gatorade,Rockwell,Georgia,serif;">' . $rango3_mensaje_premio . '</p>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="text-align:center" colspan="3">';
                                                            $body .= '<a style="background:black;color:white;text-align:center;font-size:17px;padding:12px 20px 10px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;" href="' . home_url() . '">DESCUBRE M√ÅS AQU√ç</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr>';
                                                            $body .= '<td style="padding:26px;" colspan="3">';
                                                            $body .= '<br>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr style="background:#000000;">';
                                                            $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                            $body .= '<a href="' . network_site_url() . 'wp-content/media/2021/06/TeÃÅrminos-de-Uso.pdf" style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">TERMINOS Y CONDICIONES</a>';
                                                            $body .= '</td>';
                                                            $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                            $body .= '<a href="' . network_site_url() . 'wp-content/media/2021/06/PoliÃÅtica-de-privacidad.pdf" style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;">POL√çTICAS DE PRIVACIDAD</a>';
                                                            $body .= '</td>';
                                                            $body .= '<td style="text-align:center;padding:10px 6px;" width="33%" colspan="1">';
                                                            $body .= '<a style="color:#FF8901;text-align:center;font-size:10px;padding:12px 20px 14px;text-decoration:none;font-family:Gatorade,Rockwell,Georgia,serif;" href="#">CANCELAR SUSCRIPCI√ìN</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '<tr style="background:#000000;">';
                                                            $body .= '<td style="padding:0px 16px 17px;" colspan="3">';
                                                            $body .= '<a href="' . home_url() . '">';
                                                            $body .= '<img src="' . IMGURL . 'desktop/Logo.png" style="width:33px;margin:0 auto;display:block;"/>';
                                                            $body .= '</a>';
                                                            $body .= '</td>';
                                                            $body .= '</tr>';
                                                            $body .= '</table>';
                                                            $headers = array(
                                                                'Content-Type: text/html; charset=UTF-8'
                                                            );
                                                            //Enviando el correo
                                                            wp_mail($to, $subject, $body, $headers);
                                                            $retos_contenido[$x]['rangos'][0]['email3'] = "true";
                                                            update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                        }
                                                    }
                                                    //Si el usuario no ha visto el popup
                                                    if ($retos_contenido[$x]['rangos'][0]['popup3'] == "false") {
                                                    ?>
                                                        <script>
                                                            jQuery('.msgAlert').css('display', 'flex');
                                                            jQuery('.msgAlert .txtMsg').html(`<h4 class="felicitaciones" style="text-transform:uppercase;">RETO ACTIVADO:</h4><div class="content_cont_h1_line"></div><br><div class="list_retos_logrados_el"> <div><video autoplay muted loop playsinline> <source src="<?php echo $rango3_video_premio; ?>" type="video/mp4"> </video></div><h3> <?php echo $rango3_titulo; ?> </h3></div><p style="color: black;text-align: center;font-family: 'Gatorade black';font-size: 17px;width: 100%;margin: 0;padding: 20px 0px 8px;line-height: 19px;">¬°COMPARTE TU MEDALLA CON TUS AMIGOS E INVITALOS AL DESAFIO!</p><div class="the_champ_sharing_container the_champ_horizontal_sharing" style="padding-bottom:20px;" ss-offset="0" super-socializer-data-href="<?php echo home_url('retos'); ?>"> <div style="font-weight:bold" class="the_champ_sharing_title"></div><ul class="the_champ_sharing_ul" style="display:flex;justify-content:center;align-items:center;width:100%;"> <li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Facebook" title="Facebook" class="theChampSharing theChampFacebookBackground" onclick='theChampPopup("https://www.facebook.com/sharer/sharer.php?u=<?php echo home_url('retos'); ?>&quote=¬°Hoy supere otro Reto! √önete y Alcanza tu m√°ximo potencial. Acepta el reto <?php echo home_url(); ?>")' > <ss style="display:block;border-radius:999px;" class="theChampSharingSvg theChampFacebookSvg"> </ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Twitter" title="Twitter" class="theChampSharing theChampTwitterBackground" onclick='theChampPopup("http://twitter.com/intent/tweet?text=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ <?php echo home_url(); ?>&amp;url=<?php echo home_url('retos'); ?>")'> <ss style="display:block;border-radius:999px;" class="theChampSharingSvg theChampTwitterSvg"></ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Whatsapp" title="Whatsapp" class="theChampSharing theChampWhatsappBackground" onclick='theChampPopup("https://web.whatsapp.com/send?text=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ <?php echo home_url('retos'); ?>")' > <ss style="display:block" class="theChampSharingSvg theChampWhatsappSvg"></ss> </i> </li><li class="theChampSharingRound"> <i style="width:35px;height:35px;border-radius:999px;" alt="Email" title="Email" class="theChampSharing theChampEmailBackground" onclick="window.open('mailto:?subject=¬°Hoy supere otro Reto!üèÜ √∫nete y Alcanza tu m√°ximo potencial üí™üèºAcepta el reto  üëâ gatorade.lat&amp;body=' + decodeURIComponent('<?php echo home_url('retos'); ?>' ), '_blank')"> <ss style="display:block" class="theChampSharingSvg theChampEmailSvg"></ss> </i> </li></ul> <div style="clear:both"></div></div>`);
                                                            jQuery('.msgAlert .aMsg').css('display', 'block');
                                                            jQuery('.msgAlert .txtMsg').css('margin-bottom', '-32px');
                                                            jQuery('.msgAlert .aMsg').html('IR A TU PERFIL');
                                                            jQuery('.msgAlert .aMsg').attr('href', '<?php echo home_url('perfil'); ?>');
                                                        </script>
<?php
                                                        $retos_contenido[$x]['rangos'][0]['popup3'] = "true";
                                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                    }
                                                    //El numero de elementos a visualizar y el numero de elementos visualizados no es igual
                                                } else {
                                                    if (in_array($post->ID, $retos_contenido[$x]['post'])) {
                                                        $retos_contenido[$x]['rangos'][0]['estado3'] = 'pendiente';
                                                        $retos_contenido[$x]['rangos'][0]['popup3'] = "false";
                                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                    } else {
                                                        $retos_contenido[$x]['rangos'][0]['estado3'] = 'pendiente';
                                                        $retos_contenido[$x]['post'][] = $post->ID;
                                                        $retos_contenido[$x]['rangos'][0]['popup3'] = "false";
                                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                                    }
                                                }
                                            }
                                        }
                                    } else {
                                        array_push($retos_contenido, array(
                                            "idReto" => $id,
                                            "tipo" => "contenido",
                                            "rangos" => array(
                                                array(
                                                    "estado1" => "pendiente",
                                                    "popup1" => "false",
                                                    "email1" => "false",
                                                    "estado2" => "pendiente",
                                                    "popup2" => "false",
                                                    "email2" => "false",
                                                    "estado3" => "pendiente",
                                                    "popup3" => "false",
                                                    "email3" => "false"
                                                )
                                            ),
                                            "post" => array(
                                                $post->ID
                                            )
                                        ));
                                        update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                                    }
                                }
                            }
                        } else {
                            array_push($retos_contenido, array(
                                "idReto" => $id,
                                "tipo" => "contenido",
                                "rangos" => array(
                                    array(
                                        "estado1" => "pendiente",
                                        "popup1" => "false",
                                        "email1" => "false",
                                        "estado2" => "pendiente",
                                        "popup2" => "false",
                                        "email2" => "false",
                                        "estado3" => "pendiente",
                                        "popup3" => "false",
                                        "email3" => "false"
                                    )
                                ),
                                "post" => array(
                                    $post->ID
                                )
                            ));
                            update_user_meta($idUser, 'retos_contenido', $retos_contenido);
                        }
                    }
                }
            }



        endforeach;
    }
} else {
    //echo 'no logueado';

}

?>